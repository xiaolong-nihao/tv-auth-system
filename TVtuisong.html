<!DOCTYPE html>
<html>
<head>
    <title>ç”µè§†æ¿€æ´»ç æ¨é€</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f0f2f5; padding: 20px; }
        
        .container { max-width: 500px; margin: 0 auto; background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        
        .header { text-align: center; margin-bottom: 25px; }
        .header h1 { color: #1890ff; margin-bottom: 10px; }
        .header p { color: #666; }
        
        .info-card { background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 20px; border-left: 4px solid #1890ff; }
        .info-item { display: flex; margin-bottom: 10px; }
        .info-label { width: 100px; color: #666; }
        .info-value { flex: 1; color: #333; font-weight: bold; }
        
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; }
        .input-group input, .input-group textarea { 
            width: 100%; 
            padding: 15px; 
            border: 2px solid #e8e8e8; 
            border-radius: 8px; 
            font-size: 16px; 
            transition: border-color 0.3s; 
        }
        .input-group input:focus, .input-group textarea:focus { 
            border-color: #1890ff; 
            outline: none; 
        }
        
        .btn { 
            display: block; 
            width: 100%; 
            padding: 18px; 
            background: linear-gradient(135deg, #1890ff, #096dd9); 
            color: white; 
            border: none; 
            border-radius: 8px; 
            font-size: 18px; 
            font-weight: bold; 
            cursor: pointer; 
            margin: 15px 0; 
            text-align: center;
        }
        .btn:hover { opacity: 0.9; }
        .btn.secondary { background: linear-gradient(135deg, #52c41a, #389e0d); }
        .btn.warning { background: linear-gradient(135deg, #faad14, #d48806); }
        
        .result { 
            margin-top: 20px; 
            padding: 15px; 
            border-radius: 8px; 
            display: none; 
        }
        .success { background: #f6ffed; border: 1px solid #b7eb8f; color: #52c41a; }
        .error { background: #fff2f0; border: 1px solid #ffccc7; color: #ff4d4f; }
        .info { background: #e6f7ff; border: 1px solid #91d5ff; color: #1890ff; }
        
        .loading { text-align: center; padding: 30px; display: none; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #1890ff; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .tips { 
            background: #fff7e6; 
            border: 1px solid #ffd591; 
            border-radius: 8px; 
            padding: 15px; 
            margin-top: 20px; 
            color: #d46b08; 
            font-size: 14px; 
        }
        
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“º ç”µè§†æ¿€æ´»ç æ¨é€</h1>
            <p>æ‰«ç åè‡ªåŠ¨è¿›å…¥æ­¤é¡µé¢ï¼Œè¾“å…¥æ¿€æ´»ç ä¸€é”®æ¨é€</p>
        </div>
        
        <div class="info-card">
            <h3>è®¾å¤‡ä¿¡æ¯</h3>
            <div class="info-item">
                <div class="info-label">ç”µè§†IP:</div>
                <div class="info-value" id="tv-ip">æ­£åœ¨è·å–...</div>
            </div>
            <div class="info-item">
                <div class="info-label">ä¼šè¯ID:</div>
                <div class="info-value" id="session-id">æ­£åœ¨è·å–...</div>
            </div>
            <div class="info-item">
                <div class="info-label">çŠ¶æ€:</div>
                <div class="info-value" id="status">
                    <span style="color: #faad14;">ç­‰å¾…è¿æ¥...</span>
                </div>
            </div>
        </div>
        
        <div class="input-group">
            <label for="activation-code">æ¿€æ´»ç </label>
            <textarea 
                id="activation-code" 
                rows="4" 
                placeholder="è¯·ç²˜è´´ä½ çš„é•¿æ¿€æ´»ç ï¼ˆä»æ¿€æ´»ç ç”Ÿæˆå·¥å…·å¤åˆ¶ï¼‰"
                autocomplete="off"
                autocorrect="off"
                autocapitalize="off"
                spellcheck="false">
            </textarea>
            <div style="margin-top: 10px; font-size: 14px; color: #666;">
                æç¤ºï¼šæ¿€æ´»ç é€šå¸¸ä¸º16-32ä½çš„å­—æ¯æ•°å­—ç»„åˆ
            </div>
        </div>
        
        <button class="btn" onclick="sendActivation()" id="send-btn">
            ğŸš€ æ¨é€æ¿€æ´»ç åˆ°ç”µè§†
        </button>
        
        <button class="btn secondary" onclick="testConnection()">
            ğŸ” æµ‹è¯•ç”µè§†è¿æ¥
        </button>
        
        <div id="result" class="result"></div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p id="loading-text">å¤„ç†ä¸­...</p>
        </div>
        
        <div class="tips">
            <strong>ğŸ’¡ ä½¿ç”¨æç¤ºï¼š</strong>
            <p>1. ç¡®ä¿æ‰‹æœºå’Œç”µè§†åœ¨åŒä¸€WiFiç½‘ç»œ</p>
            <p>2. ç”µè§†éœ€ä¿æŒæ¿€æ´»ç•Œé¢å¼€å¯</p>
            <p>3. æ¿€æ´»ç åªä½¿ç”¨ä¸€æ¬¡ï¼Œå‘é€åè¯·å‹¿é‡å¤</p>
        </div>
    </div>

    <script>
        // è§£æURLå‚æ•°
        function getUrlParams() {
            const params = {};
            const query = window.location.search.substring(1);
            const pairs = query.split('&');
            
            for (let pair of pairs) {
                const [key, value] = pair.split('=');
                if (key && value) {
                    params[decodeURIComponent(key)] = decodeURIComponent(value);
                }
            }
            return params;
        }
        
        // æ˜¾ç¤ºç»“æœ
        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = message;
            resultDiv.className = 'result ' + type;
            resultDiv.style.display = 'block';
            
            // 5ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                resultDiv.style.display = 'none';
            }, 5000);
        }
        
        // æ˜¾ç¤ºåŠ è½½
        function showLoading(text) {
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading').style.display = 'block';
            document.getElementById('send-btn').disabled = true;
        }
        
        // éšè—åŠ è½½
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('send-btn').disabled = false;
        }
        
        // æ›´æ–°çŠ¶æ€
        function updateStatus(message, color) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<span style="color: ${color};">${message}</span>`;
        }
        
        // ä¸»é€»è¾‘
        function main() {
            const params = getUrlParams();
            let sessionId = params.session || '';
            let tvIp = params.ip || '';
            
            // å¦‚æœå‚æ•°ä¸­æ²¡æœ‰ï¼Œå°è¯•ä»äºŒç»´ç å†…å®¹è§£æ
            if (!sessionId && !tvIp) {
                // å°è¯•è§£æå½“å‰URLçš„hashéƒ¨åˆ†
                const hash = window.location.hash.substring(1);
                if (hash) {
                    const parts = hash.split(':');
                    if (parts.length >= 2) {
                        sessionId = parts[0];
                        tvIp = '255.255.255.255'; // å¹¿æ’­åœ°å€
                    }
                }
            }
            
            // æ˜¾ç¤ºè®¾å¤‡ä¿¡æ¯
            document.getElementById('session-id').textContent = sessionId || 'æœªè¯†åˆ«';
            document.getElementById('tv-ip').textContent = tvIp || 'å¹¿æ’­æ¨¡å¼';
            
            // è‡ªåŠ¨æµ‹è¯•è¿æ¥
            if (sessionId) {
                testConnection();
            }
            
            // æ¿€æ´»ç è¾“å…¥æ¡†è‡ªåŠ¨èšç„¦
            document.getElementById('activation-code').focus();
            
            // ç›‘å¬ç²˜è´´äº‹ä»¶
            document.getElementById('activation-code').addEventListener('paste', function(e) {
                setTimeout(() => {
                    validateActivationCode();
                }, 100);
            });
            
            // ç›‘å¬è¾“å…¥äº‹ä»¶
            document.getElementById('activation-code').addEventListener('input', validateActivationCode);
        }
        
        // éªŒè¯æ¿€æ´»ç æ ¼å¼
        function validateActivationCode() {
            const code = document.getElementById('activation-code').value.trim();
            
            if (!code) {
                return false;
            }
            
            // ç®€å•çš„æ ¼å¼éªŒè¯
            if (code.length < 8) {
                showResult('æ¿€æ´»ç é•¿åº¦ä¸è¶³', 'error');
                return false;
            }
            
            if (!/^[A-Za-z0-9]+$/.test(code)) {
                showResult('æ¿€æ´»ç åªèƒ½åŒ…å«å­—æ¯å’Œæ•°å­—', 'error');
                return false;
            }
            
            return true;
        }
        
        // æµ‹è¯•ç”µè§†è¿æ¥
        async function testConnection() {
            showLoading('æ­£åœ¨æµ‹è¯•ç”µè§†è¿æ¥...');
            updateStatus('æµ‹è¯•è¿æ¥ä¸­...', '#faad14');
            
            try {
                const sessionId = document.getElementById('session-id').textContent;
                
                // å°è¯•å‘é€æµ‹è¯•æ•°æ®
                const result = await sendUdpData(sessionId + ':TEST', '255.255.255.255', 8888);
                
                if (result.success) {
                    updateStatus('ç”µè§†åœ¨çº¿ âœ“', '#52c41a');
                    showResult('ç”µè§†è¿æ¥æ­£å¸¸ï¼Œå¯ä»¥å‘é€æ¿€æ´»ç ', 'success');
                } else {
                    updateStatus('ç”µè§†å¯èƒ½ä¸åœ¨çº¿', '#ff4d4f');
                    showResult('æ— æ³•è¿æ¥åˆ°ç”µè§†ï¼Œè¯·ç¡®ä¿ç”µè§†å·²æ‰“å¼€æ¿€æ´»ç•Œé¢', 'error');
                }
                
            } catch (error) {
                updateStatus('è¿æ¥å¤±è´¥', '#ff4d4f');
                showResult('æµ‹è¯•è¿æ¥å¤±è´¥ï¼š' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }
        
        // å‘é€æ¿€æ´»ç 
        async function sendActivation() {
            if (!validateActivationCode()) {
                showResult('è¯·å…ˆè¾“å…¥æœ‰æ•ˆçš„æ¿€æ´»ç ', 'error');
                return;
            }
            
            const sessionId = document.getElementById('session-id').textContent;
            const activationCode = document.getElementById('activation-code').value.trim();
            const tvIp = document.getElementById('tv-ip').textContent;
            
            showLoading('æ­£åœ¨å‘é€æ¿€æ´»ç ...');
            
            try {
                // æ„é€ å‘é€æ•°æ®ï¼šSESSION_ID:ACTIVATION_CODE
                const data = sessionId + ':' + activationCode;
                
                // å‘é€UDPæ•°æ®
                const result = await sendUdpData(data, tvIp, 8888);
                
                if (result.success) {
                    showResult('âœ… æ¿€æ´»ç å‘é€æˆåŠŸï¼<br>ç”µè§†æ­£åœ¨éªŒè¯ï¼Œè¯·æŸ¥çœ‹ç”µè§†å±å¹•...', 'success');
                    updateStatus('æ¿€æ´»ç å·²å‘é€ âœ“', '#52c41a');
                    
                    // æ¸…ç©ºè¾“å…¥æ¡†
                    document.getElementById('activation-code').value = '';
                    
                    // 3ç§’åè·³è½¬
                    setTimeout(() => {
                        window.location.href = 'about:blank';
                    }, 3000);
                    
                } else {
                    showResult('âŒ å‘é€å¤±è´¥ï¼š' + result.message, 'error');
                    updateStatus('å‘é€å¤±è´¥', '#ff4d4f');
                }
                
            } catch (error) {
                showResult('å‘é€é”™è¯¯ï¼š' + error.message, 'error');
                updateStatus('å‘é€é”™è¯¯', '#ff4d4f');
            } finally {
                hideLoading();
            }
        }
        
        // å‘é€UDPæ•°æ®çš„å‡½æ•°
        function sendUdpData(data, ip, port) {
            return new Promise((resolve) => {
                try {
                    // æ–¹æ³•1ï¼šä½¿ç”¨WebRTCæ•°æ®é€šé“ï¼ˆç°ä»£æµè§ˆå™¨ï¼‰
                    if (typeof RTCPeerConnection !== 'undefined') {
                        sendViaWebRTC(data, ip, port).then(resolve);
                        return;
                    }
                    
                    // æ–¹æ³•2ï¼šä½¿ç”¨WebSocketä»£ç†
                    sendViaWebSocket(data, ip, port).then(resolve);
                    
                } catch (error) {
                    resolve({ success: false, message: error.message });
                }
            });
        }
        
        // é€šè¿‡WebRTCå‘é€
        async function sendViaWebRTC(data, ip, port) {
            return new Promise((resolve) => {
                const pc = new RTCPeerConnection();
                const dc = pc.createDataChannel('activation');
                
                dc.onopen = () => {
                    dc.send(data);
                    resolve({ success: true });
                    pc.close();
                };
                
                dc.onerror = () => {
                    resolve({ success: false, message: 'WebRTCè¿æ¥å¤±è´¥' });
                };
                
                setTimeout(() => {
                    resolve({ success: false, message: 'è¿æ¥è¶…æ—¶' });
                }, 3000);
            });
        }
        
        // é€šè¿‡WebSocketå‘é€
        async function sendViaWebSocket(data, ip, port) {
            return new Promise((resolve) => {
                try {
                    // å°è¯•è¿æ¥ç”µè§†çš„WebSocket
                    const ws = new WebSocket(`ws://${ip}:${port + 1}`);
                    
                    ws.onopen = () => {
                        ws.send(data);
                        resolve({ success: true });
                        ws.close();
                    };
                    
                    ws.onerror = () => {
                        // WebSocketå¤±è´¥ï¼Œå°è¯•HTTP
                        sendViaHttp(data, ip, port).then(resolve);
                    };
                    
                    setTimeout(() => {
                        resolve({ success: false, message: 'è¿æ¥è¶…æ—¶' });
                    }, 3000);
                    
                } catch (error) {
                    resolve({ success: false, message: error.message });
                }
            });
        }
        
        // é€šè¿‡HTTPå‘é€
        async function sendViaHttp(data, ip, port) {
            try {
                // ä½¿ç”¨fetchå‘é€
                const response = await fetch(`http://${ip}:${port}/activate`, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: data
                });
                
                return { success: true };
            } catch (error) {
                // æœ€åçš„æ–¹æ¡ˆï¼šä½¿ç”¨å›¾ç‰‡åŠ è½½è§¦å‘è¯·æ±‚
                const img = new Image();
                img.src = `http://${ip}:${port}/activate?data=${encodeURIComponent(data)}`;
                
                return new Promise((resolve) => {
                    img.onload = () => resolve({ success: true });
                    img.onerror = () => resolve({ success: false, message: 'æ‰€æœ‰å‘é€æ–¹å¼éƒ½å¤±è´¥' });
                });
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåè¿è¡Œ
        document.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>