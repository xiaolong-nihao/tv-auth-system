<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¾å¤‡æˆæƒç®¡ç†ç³»ç»Ÿ - å¤–é“¾ç½‘ç›˜ç‰ˆ</title>
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #1e40af;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1f2937;
            --light: #f8fafc;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            max-width: 1000px;
            margin: 0 auto;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .main-content {
            padding: 30px;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #f1f5f9;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .form-control {
            width: 100%;
            padding: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin: 5px;
        }
        
        .btn-block {
            display: flex;
            width: 100%;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            margin: 2px;
        }
        
        .status-authorized {
            background: #dcfce7;
            color: #166534;
        }
        
        .status-pending {
            background: #fef3c7;
            color: #d97706;
        }
        
        .device-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--dark);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            z-index: 10000;
        }
        
        .grid {
            display: grid;
            gap: 20px;
            margin: 20px 0;
        }
        
        .grid-2 {
            grid-template-columns: 1fr 1fr;
        }
        
        .grid-3 {
            grid-template-columns: 1fr 1fr 1fr;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- å¤–é“¾é…ç½®é¡µé¢ -->
    <div id="configPage" class="container">
        <div class="header">
            <h1>ğŸ”— å¤–é“¾ç½‘ç›˜é…ç½®</h1>
            <p>é…ç½®æ‚¨çš„ authorized_devices.json æ–‡ä»¶å¤–é“¾</p>
        </div>
        
        <div class="main-content">
            <div class="card">
                <h3>å¿«é€Ÿé…ç½®</h3>
                <p style="margin: 15px 0; color: #64748b;">
                    æ£€æµ‹åˆ°æ‚¨å·²æœ‰å¤–é“¾åœ°å€ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¿«é€Ÿé…ç½®
                </p>
                <button class="btn btn-success btn-block" onclick="quickSetup()">
                    ğŸš€ å¿«é€Ÿé…ç½®: https://13035.kstore.space/å¡å¯†/authorized_devices.json
                </button>
            </div>
            
            <div class="card">
                <h3>æ‰‹åŠ¨é…ç½®</h3>
                <p style="margin: 15px 0; color: #64748b;">
                    æˆ–è€…æ‰‹åŠ¨ä¿®æ”¹å¤–é“¾åœ°å€
                </p>
                
                <div class="form-group">
                    <label>authorized_devices.json å¤–é“¾åœ°å€:</label>
                    <input type="url" id="fileUrl" class="form-control" 
                           value="https://13035.kstore.space/å¡å¯†/authorized_devices.json"
                           placeholder="https://æ‚¨çš„åŸŸå/authorized_devices.json">
                </div>
                
                <div class="form-group">
                    <label>è®¿é—®å¯†ç  (å¯é€‰):</label>
                    <input type="password" id="accessPassword" class="form-control" 
                           placeholder="å¦‚æœå¤–é“¾éœ€è¦å¯†ç è®¿é—®">
                </div>
                
                <button class="btn btn-primary btn-block" onclick="saveConfig()">
                    ğŸ’¾ ä¿å­˜é…ç½®
                </button>
            </div>
            
            <div class="card">
                <h3>å½“å‰é…ç½®çŠ¶æ€</h3>
                <div id="configStatus">
                    <p>ç­‰å¾…é…ç½®...</p>
                </div>
            </div>

            <div class="card">
                <h3>é¦–æ¬¡ä½¿ç”¨è¯´æ˜</h3>
                <div style="color: #64748b; line-height: 1.6;">
                    <p><strong>æ­¥éª¤ 1:</strong> ç‚¹å‡»"å¿«é€Ÿé…ç½®"æŒ‰é’®</p>
                    <p><strong>æ­¥éª¤ 2:</strong> ç³»ç»Ÿä¼šå°è¯•ä»æ‚¨çš„å¤–é“¾åŠ è½½æ•°æ®</p>
                    <p><strong>æ­¥éª¤ 3:</strong> å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œç³»ç»Ÿä¼šå¼•å¯¼æ‚¨åˆ›å»ºåˆå§‹æ–‡ä»¶</p>
                    <p><strong>æ­¥éª¤ 4:</strong> å°†ç”Ÿæˆçš„æ–‡ä»¶ä¸Šä¼ åˆ°æ‚¨çš„ kstore.space ç½‘ç›˜</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»ç®¡ç†ç³»ç»Ÿ -->
    <div id="mainPage" class="container" style="display: none;">
        <div class="header">
            <h1>ğŸ“± è®¾å¤‡æˆæƒç®¡ç†ç³»ç»Ÿ</h1>
            <p>åŸºäºå¤–é“¾ç½‘ç›˜çš„æ•°æ®å­˜å‚¨ | <span id="deviceCount">0 ä¸ªè®¾å¤‡</span></p>
        </div>
        
        <div class="main-content">
            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="grid grid-3">
                <div class="card">
                    <h4>æ€»è®¾å¤‡æ•°</h4>
                    <h2 id="totalDevices">0</h2>
                </div>
                <div class="card">
                    <h4>å½“å‰è®¾å¤‡çŠ¶æ€</h4>
                    <div id="currentDeviceStatus" class="status-badge status-pending">
                        æœªéªŒè¯
                    </div>
                </div>
                <div class="card">
                    <h4>æœ€ååŒæ­¥</h4>
                    <div id="lastSync">ä»æœªåŒæ­¥</div>
                </div>
            </div>
            
            <!-- è®¾å¤‡ç®¡ç† -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>è®¾å¤‡ç®¡ç†</h3>
                    <div>
                        <button class="btn btn-primary" onclick="syncData()">
                            ğŸ”„ åŒæ­¥æ•°æ®
                        </button>
                        <button class="btn btn-success" onclick="showAddDeviceModal()">
                            â• æ·»åŠ è®¾å¤‡
                        </button>
                    </div>
                </div>
                
                <div id="devicesList">
                    <!-- è®¾å¤‡åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>

            <!-- å½“å‰è®¾å¤‡ä¿¡æ¯ -->
            <div class="card">
                <h3 style="margin-bottom: 15px;">å½“å‰è®¾å¤‡ä¿¡æ¯</h3>
                <div class="device-item">
                    <strong>è®¾å¤‡æŒ‡çº¹:</strong>
                    <div style="font-family: monospace; font-size: 12px; color: #64748b; margin: 5px 0; word-break: break-all;">
                        <span id="currentFingerprintDisplay">ç”Ÿæˆä¸­...</span>
                    </div>
                    <div style="font-size: 12px; color: #64748b;">
                        å¤åˆ¶æ­¤æŒ‡çº¹ç”¨äºæ·»åŠ æ–°è®¾å¤‡
                    </div>
                </div>
            </div>
            
            <!-- ç³»ç»Ÿç®¡ç† -->
            <div class="card">
                <h3 style="margin-bottom: 15px;">ç³»ç»Ÿç®¡ç†</h3>
                <button class="btn btn-primary" onclick="exportData()">
                    ğŸ’¾ å¯¼å‡ºæ•°æ®æ–‡ä»¶
                </button>
                <button class="btn btn-danger" onclick="resetSystem()">
                    ğŸ—‘ï¸ é‡ç½®ç³»ç»Ÿ
                </button>
                <button class="btn" onclick="showConfigPage()" style="background: #e2e8f0;">
                    âš™ï¸ é‡æ–°é…ç½®
                </button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ è®¾å¤‡æ¨¡æ€æ¡† -->
    <div id="addDeviceModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000;">
        <div style="background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 500px;">
            <h3 style="margin-bottom: 20px;">æ·»åŠ æˆæƒè®¾å¤‡</h3>
            <div class="form-group">
                <label>è®¾å¤‡æŒ‡çº¹:</label>
                <input type="text" id="newDeviceFingerprint" class="form-control" placeholder="è¾“å…¥è®¾å¤‡æŒ‡çº¹">
            </div>
            <div class="form-group">
                <label>è®¾å¤‡åç§°:</label>
                <input type="text" id="newDeviceName" class="form-control" placeholder="è¾“å…¥è®¾å¤‡æè¿°">
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn" onclick="closeAddDeviceModal()" style="background: #e2e8f0;">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="addDevice()">æ·»åŠ è®¾å¤‡</button>
            </div>
        </div>
    </div>

    <script>
        // ç³»ç»Ÿé…ç½®
        let systemConfig = {
            fileUrl: '',
            accessPassword: '',
            data: null
        };

        // å½“å‰è®¾å¤‡ä¿¡æ¯
        let currentDevice = {
            fingerprint: null,
            isAuthorized: false
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeSystem();
        });

        // åˆå§‹åŒ–ç³»ç»Ÿ
        async function initializeSystem() {
            await generateDeviceFingerprint();
            loadConfig();
        }

        // ç”Ÿæˆè®¾å¤‡æŒ‡çº¹
        async function generateDeviceFingerprint() {
            try {
                const components = [
                    navigator.userAgent,
                    navigator.platform,
                    navigator.language,
                    screen.width + 'x' + screen.height,
                    new Date().getTimezoneOffset().toString(),
                    navigator.hardwareConcurrency || 'unknown'
                ];
                
                const fingerprintString = components.join('|');
                const hashBuffer = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(fingerprintString));
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                currentDevice.fingerprint = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                
                if (document.getElementById('currentFingerprintDisplay')) {
                    document.getElementById('currentFingerprintDisplay').textContent = currentDevice.fingerprint;
                }
            } catch (error) {
                console.error('ç”Ÿæˆè®¾å¤‡æŒ‡çº¹å¤±è´¥:', error);
                currentDevice.fingerprint = 'fingerprint_error_' + Date.now();
            }
        }

        // å¿«é€Ÿé…ç½®
        function quickSetup() {
            systemConfig.fileUrl = 'https://13035.kstore.space/å¡å¯†/authorized_devices.json';
            document.getElementById('fileUrl').value = systemConfig.fileUrl;
            saveConfig();
        }

        // åŠ è½½é…ç½®
        function loadConfig() {
            const savedConfig = localStorage.getItem('systemConfig');
            if (savedConfig) {
                systemConfig = JSON.parse(savedConfig);
                document.getElementById('fileUrl').value = systemConfig.fileUrl;
                document.getElementById('accessPassword').value = systemConfig.accessPassword;
                updateConfigStatus();
                
                if (systemConfig.fileUrl) {
                    // è‡ªåŠ¨åŠ è½½æ•°æ®
                    setTimeout(() => {
                        loadData();
                    }, 1000);
                }
            }
        }

        // ä¿å­˜é…ç½®
        async function saveConfig() {
            const fileUrl = document.getElementById('fileUrl').value.trim();
            const accessPassword = document.getElementById('accessPassword').value.trim();
            
            if (!fileUrl) {
                alert('è¯·è¾“å…¥å¤–é“¾åœ°å€');
                return;
            }
            
            systemConfig.fileUrl = fileUrl;
            systemConfig.accessPassword = accessPassword;
            
            localStorage.setItem('systemConfig', JSON.stringify(systemConfig));
            updateConfigStatus();
            showToast('é…ç½®ä¿å­˜æˆåŠŸ');
            
            // å°è¯•åŠ è½½æ•°æ®
            await loadData();
        }

        // æ›´æ–°é…ç½®çŠ¶æ€
        function updateConfigStatus() {
            const statusDiv = document.getElementById('configStatus');
            if (systemConfig.fileUrl) {
                statusDiv.innerHTML = `
                    <div style="color: var(--success);">
                        âœ… å¤–é“¾é…ç½®å®Œæˆ
                        <div style="font-size: 12px; color: #64748b; margin-top: 5px;">
                            åœ°å€: ${systemConfig.fileUrl}
                        </div>
                        <div style="margin-top: 10px;">
                            <button class="btn btn-primary" onclick="testConnection()" style="padding: 8px 16px; font-size: 12px;">
                                æµ‹è¯•è¿æ¥
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        // æµ‹è¯•è¿æ¥
        async function testConnection() {
            try {
                showToast('æµ‹è¯•è¿æ¥ä¸­...');
                const response = await fetch(systemConfig.fileUrl + '?t=' + Date.now());
                if (response.ok) {
                    showToast('âœ… è¿æ¥æˆåŠŸï¼');
                } else {
                    showToast('âŒ è¿æ¥å¤±è´¥: ' + response.status);
                }
            } catch (error) {
                showToast('âŒ è¿æ¥å¤±è´¥: ' + error.message);
            }
        }

        // åŠ è½½æ•°æ®
        async function loadData() {
            try {
                showToast('æ­£åœ¨ä»å¤–é“¾åŠ è½½æ•°æ®...');
                
                const response = await fetch(systemConfig.fileUrl + '?t=' + Date.now());
                if (!response.ok) {
                    if (response.status === 404) {
                        // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºåˆå§‹æ•°æ®
                        await createInitialData();
                        return;
                    }
                    throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥: ' + response.status);
                }
                
                const data = await response.json();
                systemConfig.data = data;
                
                // æ£€æŸ¥å½“å‰è®¾å¤‡æˆæƒçŠ¶æ€
                checkDeviceAuthorization();
                
                // æ˜¾ç¤ºä¸»é¡µé¢
                showMainPage();
                updateInterface();
                
                showToast('æ•°æ®åŠ è½½æˆåŠŸ');
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                if (error.message.includes('404')) {
                    await createInitialData();
                } else {
                    showToast('åŠ è½½æ•°æ®å¤±è´¥: ' + error.message);
                }
            }
        }

        // åˆ›å»ºåˆå§‹æ•°æ®
        async function createInitialData() {
            showToast('æ£€æµ‹åˆ°é¦–æ¬¡ä½¿ç”¨ï¼Œåˆ›å»ºåˆå§‹æ•°æ®...');
            
            systemConfig.data = {
                "system_info": {
                    "name": "è®¾å¤‡æˆæƒç®¡ç†ç³»ç»Ÿ",
                    "version": "1.0.0",
                    "created_at": new Date().toISOString(),
                    "last_updated": new Date().toISOString()
                },
                "security_config": {
                    "admin_password_hash": "8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92",
                    "max_devices": 10,
                    "auto_cleanup": true
                },
                "authorized_devices": [
                    {
                        "device_id": "admin_device_" + Date.now(),
                        "fingerprint": currentDevice.fingerprint,
                        "device_name": "ç®¡ç†å‘˜è®¾å¤‡",
                        "authorized_at": new Date().toISOString(),
                        "last_login": new Date().toISOString(),
                        "permissions": ["admin", "read", "write", "delete"],
                        "status": "active",
                        "is_current": true
                    }
                ],
                "pending_requests": [],
                "backup_info": {
                    "last_backup": new Date().toISOString(),
                    "backup_count": 1
                }
            };
            
            // ä¸‹è½½åˆå§‹æ–‡ä»¶è®©ç”¨æˆ·ä¸Šä¼ 
            await exportData();
            
            // æ˜¾ç¤ºä¸»é¡µé¢
            checkDeviceAuthorization();
            showMainPage();
            updateInterface();
            
            showToast('åˆå§‹æ•°æ®å·²åˆ›å»ºï¼Œè¯·ä¸‹è½½æ–‡ä»¶å¹¶ä¸Šä¼ åˆ°æ‚¨çš„ç½‘ç›˜');
        }

        // æ£€æŸ¥è®¾å¤‡æˆæƒ
        function checkDeviceAuthorization() {
            if (!systemConfig.data || !currentDevice.fingerprint) return;
            
            const authorized = systemConfig.data.authorized_devices.some(
                device => device.fingerprint === currentDevice.fingerprint
            );
            
            currentDevice.isAuthorized = authorized;
        }

        // æ˜¾ç¤ºä¸»é¡µé¢
        function showMainPage() {
            document.getElementById('configPage').style.display = 'none';
            document.getElementById('mainPage').style.display = 'block';
        }

        // æ˜¾ç¤ºé…ç½®é¡µé¢
        function showConfigPage() {
            document.getElementById('configPage').style.display = 'block';
            document.getElementById('mainPage').style.display = 'none';
        }

        // æ›´æ–°ç•Œé¢
        function updateInterface() {
            if (!systemConfig.data) return;
            
            const devices = systemConfig.data.authorized_devices;
            
            // æ›´æ–°è®¡æ•°
            document.getElementById('totalDevices').textContent = devices.length;
            document.getElementById('deviceCount').textContent = devices.length + ' ä¸ªè®¾å¤‡';
            
            // æ›´æ–°è®¾å¤‡çŠ¶æ€
            const statusElement = document.getElementById('currentDeviceStatus');
            if (currentDevice.isAuthorized) {
                statusElement.textContent = 'å·²æˆæƒ';
                statusElement.className = 'status-badge status-authorized';
            } else {
                statusElement.textContent = 'æœªæˆæƒ';
                statusElement.style.background = '#fef2f2';
                statusElement.style.color = '#dc2626';
            }
            
            // æ›´æ–°æœ€ååŒæ­¥æ—¶é—´
            document.getElementById('lastSync').textContent = new Date().toLocaleString();
            
            // æ›´æ–°è®¾å¤‡åˆ—è¡¨
            updateDevicesList();
            
            // æ›´æ–°å½“å‰è®¾å¤‡æŒ‡çº¹æ˜¾ç¤º
            if (document.getElementById('currentFingerprintDisplay')) {
                document.getElementById('currentFingerprintDisplay').textContent = currentDevice.fingerprint;
            }
        }

        // æ›´æ–°è®¾å¤‡åˆ—è¡¨
        function updateDevicesList() {
            const devicesList = document.getElementById('devicesList');
            const devices = systemConfig.data.authorized_devices;
            
            devicesList.innerHTML = '';
            
            if (devices.length === 0) {
                devicesList.innerHTML = '<p style="color: #64748b; text-align: center;">æš‚æ— æˆæƒè®¾å¤‡</p>';
                return;
            }
            
            devices.forEach(device => {
                const isCurrent = device.fingerprint === currentDevice.fingerprint;
                const deviceElement = document.createElement('div');
                deviceElement.className = 'device-item';
                deviceElement.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <strong>${device.device_name}</strong>
                            ${isCurrent ? '<span class="status-badge status-authorized">å½“å‰è®¾å¤‡</span>' : ''}
                            <div style="font-size: 12px; color: #64748b; margin-top: 5px;">
                                æŒ‡çº¹: ${device.fingerprint.substring(0, 16)}...
                            </div>
                            <div style="font-size: 12px; color: #64748b;">
                                æˆæƒæ—¶é—´: ${new Date(device.authorized_at).toLocaleDateString()}
                            </div>
                        </div>
                        <div>
                            ${!isCurrent ? `
                                <button class="btn btn-danger" onclick="removeDevice('${device.fingerprint}')" style="padding: 6px 12px; font-size: 12px;">
                                    ç§»é™¤
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
                devicesList.appendChild(deviceElement);
            });
        }

        // åŒæ­¥æ•°æ®
        function syncData() {
            loadData();
        }

        // æ˜¾ç¤ºæ·»åŠ è®¾å¤‡æ¨¡æ€æ¡†
        function showAddDeviceModal() {
            // è‡ªåŠ¨å¡«å……å½“å‰è®¾å¤‡æŒ‡çº¹
            document.getElementById('newDeviceFingerprint').value = currentDevice.fingerprint;
            document.getElementById('newDeviceName').value = 'æ–°è®¾å¤‡';
            document.getElementById('addDeviceModal').style.display = 'flex';
        }

        // å…³é—­æ·»åŠ è®¾å¤‡æ¨¡æ€æ¡†
        function closeAddDeviceModal() {
            document.getElementById('addDeviceModal').style.display = 'none';
        }

        // æ·»åŠ è®¾å¤‡
        function addDevice() {
            const fingerprint = document.getElementById('newDeviceFingerprint').value.trim();
            const name = document.getElementById('newDeviceName').value.trim();
            
            if (!fingerprint) {
                alert('è¯·è¾“å…¥è®¾å¤‡æŒ‡çº¹');
                return;
            }
            
            if (!name) {
                alert('è¯·è¾“å…¥è®¾å¤‡åç§°');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            const exists = systemConfig.data.authorized_devices.some(
                device => device.fingerprint === fingerprint
            );
            
            if (exists) {
                alert('è¯¥è®¾å¤‡å·²å­˜åœ¨');
                return;
            }
            
            // æ·»åŠ æ–°è®¾å¤‡
            systemConfig.data.authorized_devices.push({
                device_id: 'device_' + Date.now(),
                fingerprint: fingerprint,
                device_name: name,
                authorized_at: new Date().toISOString(),
                last_login: new Date().toISOString(),
                permissions: ['read', 'write'],
                status: 'active',
                is_current: false
            });
            
            systemConfig.data.system_info.last_updated = new Date().toISOString();
            
            // ä¿å­˜æ•°æ®
            exportData();
            closeAddDeviceModal();
            updateInterface();
            showToast('è®¾å¤‡æ·»åŠ æˆåŠŸï¼Œè¯·ä¸‹è½½æ–°æ–‡ä»¶å¹¶ä¸Šä¼ åˆ°ç½‘ç›˜');
        }

        // ç§»é™¤è®¾å¤‡
        function removeDevice(fingerprint) {
            if (!confirm('ç¡®å®šè¦ç§»é™¤æ­¤è®¾å¤‡å—ï¼Ÿ')) return;
            
            systemConfig.data.authorized_devices = systemConfig.data.authorized_devices.filter(
                device => device.fingerprint !== fingerprint
            );
            
            systemConfig.data.system_info.last_updated = new Date().toISOString();
            exportData();
            updateInterface();
            showToast('è®¾å¤‡å·²ç§»é™¤ï¼Œè¯·ä¸‹è½½æ–°æ–‡ä»¶å¹¶ä¸Šä¼ åˆ°ç½‘ç›˜');
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            const dataStr = JSON.stringify(systemConfig.data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'authorized_devices.json';
            link.click();
            
            showToast('æ•°æ®æ–‡ä»¶å·²ç”Ÿæˆï¼Œè¯·ä¸‹è½½åä¸Šä¼ åˆ°æ‚¨çš„ç½‘ç›˜æ›¿æ¢æ—§æ–‡ä»¶');
        }

        // é‡ç½®ç³»ç»Ÿ
        function resetSystem() {
            if (confirm('ç¡®å®šè¦é‡ç½®ç³»ç»Ÿå—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰æœ¬åœ°é…ç½®')) {
                localStorage.clear();
                location.reload();
            }
        }

        // æ˜¾ç¤ºToastæç¤º
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 4000);
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('addDeviceModal');
            if (event.target === modal) {
                closeAddDeviceModal();
            }
        }
    </script>
</body>
</html>
