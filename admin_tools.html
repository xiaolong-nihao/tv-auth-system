<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®‰å…¨è®¾å¤‡æˆæƒç®¡ç†ç³»ç»Ÿ</title>
    <style>
        /* åŸæœ‰æ ·å¼ä¿æŒä¸å˜ï¼Œæ·»åŠ æ–°æ ·å¼ */
        
        .pending-devices {
            background: #fff7ed;
            border: 2px solid #fdba74;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .qr-code {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin: 15px 0;
            border: 1px solid #e2e8f0;
        }
        
        .copy-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        
        .copy-btn:hover {
            background: #2563eb;
        }
        
        .authorize-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .reject-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 5px;
        }
        
        .pending-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #f59e0b;
        }
    </style>
</head>
<body>
    <!-- è®¾å¤‡æˆæƒç™»å½•ç•Œé¢ - å¢åŠ äºŒç»´ç å’Œå¤åˆ¶åŠŸèƒ½ -->
    <div id="authPage" class="container">
        <div class="header">
            <h1>ğŸ”’ å®‰å…¨è®¾å¤‡æˆæƒç³»ç»Ÿ</h1>
            <p>åŸºäºè®¾å¤‡æŒ‡çº¹çš„å®‰å…¨è®¤è¯</p>
        </div>
        
        <div class="main-content">
            <div class="security-info">
                <h3 style="margin-bottom: 10px;">ğŸ” è®¾å¤‡æˆæƒç”³è¯·</h3>
                <p style="color: #64748b; font-size: 14px;">
                    è¯·å°†ä»¥ä¸‹è®¾å¤‡ä¿¡æ¯æä¾›ç»™ç®¡ç†å‘˜è¿›è¡Œæˆæƒ
                </p>
            </div>
            
            <div id="deviceInfo">
                <!-- è®¾å¤‡æŒ‡çº¹ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
            
            <!-- æ–°å¢ï¼šæˆæƒç”³è¯·è¾…åŠ©åŠŸèƒ½ -->
            <div class="qr-code">
                <h4 style="margin-bottom: 15px;">ğŸ“± å¿«é€Ÿæˆæƒ</h4>
                <div id="qrcode"></div>
                <p style="margin: 15px 0; font-size: 14px; color: #64748b;">
                    æ‰«æäºŒç»´ç å¿«é€Ÿå¤åˆ¶è®¾å¤‡æŒ‡çº¹
                </p>
                <button class="copy-btn" onclick="copyFingerprint()">
                    ğŸ“‹ å¤åˆ¶è®¾å¤‡æŒ‡çº¹
                </button>
            </div>
            
            <div id="authSection">
                <div class="form-group">
                    <label>ç®¡ç†å‘˜å¯†ç ï¼ˆé¦–æ¬¡æˆæƒä½¿ç”¨ï¼‰ï¼š</label>
                    <input type="password" id="adminPassword" class="form-control" placeholder="è¾“å…¥ç®¡ç†å‘˜å¯†ç ">
                </div>
                
                <button class="btn btn-primary" onclick="authenticateDevice()">
                    ğŸ”‘ æäº¤æˆæƒç”³è¯·
                </button>
            </div>
            
            <div id="pendingSection" style="display: none;">
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 48px; margin-bottom: 15px;">â³</div>
                    <h3 style="margin-bottom: 10px;">ç­‰å¾…è®¾å¤‡æˆæƒ</h3>
                    <p style="color: #64748b; margin-bottom: 20px;">
                        æ‚¨çš„è®¾å¤‡å·²æäº¤æˆæƒç”³è¯·ï¼Œè¯·é€šçŸ¥ç®¡ç†å‘˜è¿›è¡Œæˆæƒ
                    </p>
                    <div class="device-fingerprint" id="pendingFingerprint"></div>
                    <button class="copy-btn" onclick="copyFingerprint()" style="margin-top: 10px;">
                        ğŸ“‹ å¤åˆ¶æŒ‡çº¹ä¿¡æ¯
                    </button>
                    <p style="margin-top: 15px; font-size: 12px; color: #94a3b8;">
                        å¤åˆ¶åå‘é€ç»™ç®¡ç†å‘˜ï¼Œæˆ–è®©ç®¡ç†å‘˜æ‰«æä¸Šæ–¹äºŒç»´ç 
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»ç®¡ç†ç³»ç»Ÿ - å¢åŠ å¾…æˆæƒè®¾å¤‡ç®¡ç† -->
    <div id="adminPage" class="container" style="display: none;">
        <div class="header">
            <h1>ğŸ“± è®¾å¤‡æˆæƒç®¡ç†ç³»ç»Ÿ</h1>
            <p>å®‰å…¨è®¾å¤‡ç®¡ç†å¹³å°</p>
        </div>
        
        <div class="main-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>è®¾å¤‡æˆæƒç®¡ç†</h2>
                <span class="status-badge status-authorized" id="currentDeviceStatus">å½“å‰è®¾å¤‡å·²æˆæƒ</span>
            </div>
            
            <!-- æ–°å¢ï¼šå¾…æˆæƒè®¾å¤‡åˆ—è¡¨ -->
            <div class="pending-devices" id="pendingDevicesSection" style="display: none;">
                <h3 style="color: #d97706; margin-bottom: 15px;">ğŸ”„ å¾…æˆæƒè®¾å¤‡</h3>
                <div id="pendingDevicesList">
                    <!-- å¾…æˆæƒè®¾å¤‡åˆ—è¡¨ -->
                </div>
                <p style="font-size: 12px; color: #f59e0b; margin-top: 10px;">
                    ğŸ’¡ è¿™äº›è®¾å¤‡æ­£åœ¨ç­‰å¾…æ‚¨çš„æˆæƒæ‰¹å‡†
                </p>
            </div>
            
            <div class="security-info">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <strong>è®¾å¤‡æŒ‡çº¹ï¼š</strong><br>
                        <span id="currentFingerprint" style="font-size: 12px; color: #64748b;"></span>
                    </div>
                    <div>
                        <strong>æˆæƒæ—¶é—´ï¼š</strong><br>
                        <span id="authTime" style="font-size: 12px; color: #64748b;"></span>
                    </div>
                </div>
            </div>
            
            <div class="toggle-label">
                <span>ğŸ”’ ä¸¥æ ¼è®¾å¤‡éªŒè¯æ¨¡å¼</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="strictMode" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                <button class="btn btn-primary" onclick="showAddDeviceModal()">
                    â• æ‰‹åŠ¨æ·»åŠ è®¾å¤‡
                </button>
                <button class="btn btn-success" onclick="refreshPendingDevices()">
                    ğŸ”„ åˆ·æ–°å¾…æˆæƒåˆ—è¡¨
                </button>
            </div>
            
            <h3 style="margin: 20px 0 10px 0;">å·²æˆæƒè®¾å¤‡</h3>
            <div class="device-table">
                <div class="table-header">
                    <div>è®¾å¤‡ä¿¡æ¯</div>
                    <div>æˆæƒæ—¶é—´</div>
                    <div>çŠ¶æ€</div>
                </div>
                <div id="authorizedDevicesList">
                    <!-- æˆæƒè®¾å¤‡åˆ—è¡¨ -->
                </div>
            </div>
            
            <button class="btn btn-danger" onclick="logout()" style="margin-top: 20px;">
                ğŸšª å®‰å…¨é€€å‡º
            </button>
        </div>
    </div>

    <!-- æ·»åŠ è®¾å¤‡æ¨¡æ€æ¡† -->
    <div id="addDeviceModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 15px;">æ·»åŠ æˆæƒè®¾å¤‡</h3>
            <p style="color: #64748b; margin-bottom: 20px; font-size: 14px;">
                è¯·è®©æ–°è®¾å¤‡è®¿é—®ç³»ç»Ÿå¹¶å¤åˆ¶å…¶è®¾å¤‡æŒ‡çº¹ï¼Œæˆ–ä»å¾…æˆæƒåˆ—è¡¨ä¸­é€‰æ‹©ï¼š
            </p>
            
            <div class="form-group">
                <label>è®¾å¤‡æŒ‡çº¹ï¼š</label>
                <textarea id="newDeviceFingerprint" class="form-control" rows="4" placeholder="ç²˜è´´æ–°è®¾å¤‡çš„æŒ‡çº¹ä¿¡æ¯"></textarea>
            </div>
            
            <div class="form-group">
                <label>è®¾å¤‡å¤‡æ³¨ï¼š</label>
                <input type="text" id="deviceNote" class="form-control" placeholder="è¾“å…¥è®¾å¤‡æè¿°ï¼ˆå¯é€‰ï¼‰">
            </div>
            
            <div class="modal-actions">
                <button class="btn" onclick="closeAddDeviceModal()" style="background: #e5e7eb; color: #374151;">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="addAuthorizedDevice()">æˆæƒè®¾å¤‡</button>
            </div>
        </div>
    </div>

    <script>
        // å¼•å…¥QRCodeåº“ï¼ˆç®€åŒ–ç‰ˆï¼‰
        function generateQRCode(text, elementId) {
            const container = document.getElementById(elementId);
            if (!container) return;
            
            // ç®€åŒ–ç‰ˆäºŒç»´ç ç”Ÿæˆ - å®é™…é¡¹ç›®ä¸­å»ºè®®ä½¿ç”¨ä¸“ä¸šåº“
            container.innerHTML = `
                <div style="
                    width: 150px; 
                    height: 150px; 
                    margin: 0 auto; 
                    background: #f8fafc; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    border: 1px dashed #cbd5e1;
                    border-radius: 8px;
                    font-size: 12px;
                    color: #64748b;
                ">
                    ğŸ“± QR Code<br>
                    <small>è®¾å¤‡æŒ‡çº¹äºŒç»´ç </small>
                </div>
            `;
        }

        // å¤åˆ¶è®¾å¤‡æŒ‡çº¹
        function copyFingerprint() {
            const fingerprint = deviceFingerprint;
            navigator.clipboard.writeText(fingerprint).then(() => {
                showToast('è®¾å¤‡æŒ‡çº¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }).catch(() => {
                // å…¼å®¹æ—§æµè§ˆå™¨
                const textArea = document.createElement('textarea');
                textArea.value = fingerprint;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast('è®¾å¤‡æŒ‡çº¹å·²å¤åˆ¶');
            });
        }

        // åˆ·æ–°å¾…æˆæƒè®¾å¤‡åˆ—è¡¨
        function refreshPendingDevices() {
            loadPendingDevices();
            showToast('å¾…æˆæƒåˆ—è¡¨å·²åˆ·æ–°');
        }

        // åŠ è½½å¾…æˆæƒè®¾å¤‡åˆ—è¡¨
        function loadPendingDevices() {
            const pendingDevices = JSON.parse(localStorage.getItem('pendingDevices') || '[]');
            const pendingListDiv = document.getElementById('pendingDevicesList');
            const pendingSection = document.getElementById('pendingDevicesSection');
            
            if (pendingDevices.length === 0) {
                pendingSection.style.display = 'none';
                return;
            }
            
            pendingSection.style.display = 'block';
            pendingListDiv.innerHTML = '';
            
            pendingDevices.forEach((fingerprint, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'pending-item';
                itemDiv.innerHTML = `
                    <div style="display: flex; justify-content: between; align-items: start;">
                        <div style="flex: 1;">
                            <strong>å¾…æˆæƒè®¾å¤‡ #${index + 1}</strong>
                            <div style="font-family: monospace; font-size: 11px; color: #64748b; margin: 5px 0; word-break: break-all;">
                                ${fingerprint}
                            </div>
                            <div style="font-size: 12px; color: #94a3b8;">
                                ç”³è¯·æ—¶é—´: ${new Date().toLocaleString()}
                            </div>
                        </div>
                        <div>
                            <button class="authorize-btn" onclick="authorizeDevice('${fingerprint}')">
                                âœ… æˆæƒ
                            </button>
                            <button class="reject-btn" onclick="rejectDevice('${fingerprint}')">
                                âŒ æ‹’ç»
                            </button>
                        </div>
                    </div>
                `;
                pendingListDiv.appendChild(itemDiv);
            });
        }

        // æˆæƒè®¾å¤‡
        function authorizeDevice(fingerprint) {
            const note = prompt('è¯·è¾“å…¥è®¾å¤‡å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰:', `è®¾å¤‡-${new Date().toLocaleDateString()}`);
            
            if (authorizedDevices.length >= SECURITY_CONFIG.MAX_AUTH_DEVICES) {
                alert(`å·²è¾¾åˆ°æœ€å¤§æˆæƒè®¾å¤‡æ•°é‡ (${SECURITY_CONFIG.MAX_AUTH_DEVICES})`);
                return;
            }
            
            // æ·»åŠ åˆ°æˆæƒåˆ—è¡¨
            authorizedDevices.push({
                fingerprint: fingerprint,
                note: note || `è®¾å¤‡-${new Date().toLocaleDateString()}`,
                authTime: new Date().toISOString()
            });
            
            // ä»å¾…æˆæƒåˆ—è¡¨ä¸­ç§»é™¤
            const pendingDevices = JSON.parse(localStorage.getItem('pendingDevices') || '[]');
            const updatedPending = pendingDevices.filter(fp => fp !== fingerprint);
            localStorage.setItem('pendingDevices', JSON.stringify(updatedPending));
            
            // ä¿å­˜æˆæƒè®¾å¤‡åˆ—è¡¨
            localStorage.setItem('authorizedDevices', JSON.stringify(authorizedDevices));
            
            // åˆ·æ–°ç•Œé¢
            loadPendingDevices();
            loadAuthorizedDevicesList();
            showToast('è®¾å¤‡æˆæƒæˆåŠŸ');
        }

        // æ‹’ç»è®¾å¤‡æˆæƒ
        function rejectDevice(fingerprint) {
            if (!confirm('ç¡®å®šè¦æ‹’ç»è¯¥è®¾å¤‡çš„æˆæƒç”³è¯·å—ï¼Ÿ')) return;
            
            // ä»å¾…æˆæƒåˆ—è¡¨ä¸­ç§»é™¤
            const pendingDevices = JSON.parse(localStorage.getItem('pendingDevices') || '[]');
            const updatedPending = pendingDevices.filter(fp => fp !== fingerprint);
            localStorage.setItem('pendingDevices', JSON.stringify(updatedPending));
            
            // åˆ·æ–°ç•Œé¢
            loadPendingDevices();
            showToast('è®¾å¤‡æˆæƒç”³è¯·å·²æ‹’ç»');
        }

        // ä¿®æ”¹åˆå§‹åŒ–å‡½æ•°ï¼Œæ·»åŠ äºŒç»´ç ç”Ÿæˆ
        async function initializeSecurity() {
            // ç”Ÿæˆè®¾å¤‡æŒ‡çº¹
            deviceFingerprint = await generateDeviceFingerprint();
            
            // åŠ è½½æˆæƒè®¾å¤‡åˆ—è¡¨
            loadAuthorizedDevices();
            
            // æ˜¾ç¤ºè®¾å¤‡ä¿¡æ¯
            displayDeviceInfo();
            
            // ç”ŸæˆäºŒç»´ç 
            generateQRCode(deviceFingerprint, 'qrcode');
        }

        // ä¿®æ”¹æ˜¾ç¤ºç®¡ç†é¡µé¢å‡½æ•°ï¼ŒåŠ è½½å¾…æˆæƒåˆ—è¡¨
        function showAdminPage() {
            document.getElementById('authPage').style.display = 'none';
            document.getElementById('adminPage').style.display = 'block';
            
            // æ›´æ–°ç•Œé¢ä¿¡æ¯
            document.getElementById('currentFingerprint').textContent = deviceFingerprint;
            document.getElementById('authTime').textContent = new Date().toLocaleString();
            
            loadAuthorizedDevicesList();
            loadPendingDevices(); // åŠ è½½å¾…æˆæƒåˆ—è¡¨
        }

        // ä¿®æ”¹è®¾å¤‡è®¤è¯å‡½æ•°ï¼Œä¼˜åŒ–ç”¨æˆ·ä½“éªŒ
        async function authenticateDevice() {
            const password = document.getElementById('adminPassword').value;
            
            // å¦‚æœè®¾å¤‡å·²æˆæƒï¼Œç›´æ¥ç™»å½•ï¼ˆä¸éœ€è¦å¯†ç ï¼‰
            if (isDeviceAuthorized()) {
                createSession();
                showAdminPage();
                return;
            }
            
            // æ–°è®¾å¤‡éœ€è¦éªŒè¯å¯†ç 
            if (!password) {
                alert('è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç è¿›è¡Œé¦–æ¬¡æˆæƒ');
                return;
            }
            
            const passwordHash = await sha256(password);
            if (passwordHash !== SECURITY_CONFIG.ADMIN_PASSWORD) {
                alert('ç®¡ç†å‘˜å¯†ç é”™è¯¯');
                return;
            }
            
            // å¦‚æœæ˜¯ç®¡ç†å‘˜å¯†ç æ­£ç¡®ï¼Œè‡ªåŠ¨æˆæƒå½“å‰è®¾å¤‡
            if (authorizedDevices.length === 0) {
                // é¦–æ¬¡ä½¿ç”¨ï¼Œè‡ªåŠ¨æˆæƒå½“å‰è®¾å¤‡
                authorizedDevices.push({
                    fingerprint: deviceFingerprint,
                    note: 'ç®¡ç†å‘˜è®¾å¤‡',
                    authTime: new Date().toISOString()
                });
                localStorage.setItem('authorizedDevices', JSON.stringify(authorizedDevices));
                createSession();
                showAdminPage();
                showToast('ç®¡ç†å‘˜è®¾å¤‡å·²è‡ªåŠ¨æˆæƒ');
            } else {
                // éé¦–æ¬¡ï¼Œæäº¤æˆæƒç”³è¯·
                const pendingDevices = JSON.parse(localStorage.getItem('pendingDevices') || '[]');
                if (!pendingDevices.includes(deviceFingerprint)) {
                    pendingDevices.push(deviceFingerprint);
                    localStorage.setItem('pendingDevices', JSON.stringify(pendingDevices));
                }
                showPendingSection();
                showToast('è®¾å¤‡æˆæƒç”³è¯·å·²æäº¤ï¼Œè¯·ç­‰å¾…ç®¡ç†å‘˜æˆæƒ');
            }
        }

        // å…¶ä½™å‡½æ•°ä¿æŒä¸å˜...
    </script>
</body>
</html>
