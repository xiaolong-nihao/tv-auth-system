<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理员授权系统</title>
    <style>
        /* 样式同上，省略重复部分 */
        .search-box {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        
        .device-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .device-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>⚙️ 管理员授权系统</h1>
            <p>设备授权管理后台</p>
        </div>
        
        <div class="main-content">
            <!-- 设备搜索 -->
            <div class="card">
                <h3>设备搜索</h3>
                <div class="search-box">
                    <input type="text" id="searchFingerprint" class="form-control" 
                           placeholder="输入设备指纹进行搜索...">
                    <button class="btn btn-primary" onclick="searchDevice()">搜索</button>
                </div>
            </div>

            <!-- 设备授权管理 -->
            <div class="card">
                <h3>设备授权管理</h3>
                <div class="device-list" id="deviceList">
                    <!-- 设备列表 -->
                </div>
            </div>

            <!-- 手动添加设备 -->
            <div class="card">
                <h3>手动添加/编辑设备</h3>
                <div class="form-group">
                    <label>设备指纹：</label>
                    <input type="text" id="editFingerprint" class="form-control" 
                           placeholder="输入设备指纹">
                </div>
                <div class="form-group">
                    <label>设备名称：</label>
                    <input type="text" id="editDeviceName" class="form-control" 
                           placeholder="输入设备描述">
                </div>
                <div class="form-group">
                    <label>授权天数：</label>
                    <input type="number" id="editAuthDays" class="form-control" 
                           value="30" min="1" max="3650">
                </div>
                <div class="form-group">
                    <label>到期时间：</label>
                    <input type="date" id="editExpireDate" class="form-control">
                </div>
                <button class="btn btn-success" onclick="saveDevice()">保存设备授权</button>
            </div>

            <!-- 数据管理 -->
            <div class="card">
                <h3>数据管理</h3>
                <button class="btn btn-primary" onclick="exportData()">导出授权数据</button>
                <button class="btn" onclick="importData()" style="background: #e2e8f0;">导入数据</button>
                <button class="btn btn-danger" onclick="clearExpired()">清理过期设备</button>
            </div>
        </div>
    </div>

    <script>
        // 设备数据
        let devices = [];

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadDevices();
        });

        // 加载设备数据
        function loadDevices() {
            const saved = localStorage.getItem('authorizedDevices');
            if (saved) {
                devices = JSON.parse(saved);
                updateDeviceList();
            }
        }

        // 保存设备数据
        function saveDevices() {
            localStorage.setItem('authorizedDevices', JSON.stringify(devices));
        }

        // 搜索设备
        function searchDevice() {
            const searchTerm = document.getElementById('searchFingerprint').value.trim();
            if (!searchTerm) {
                updateDeviceList();
                return;
            }

            const filteredDevices = devices.filter(device => 
                device.fingerprint.includes(searchTerm) || 
                device.name.includes(searchTerm)
            );
            
            updateDeviceList(filteredDevices);
        }

        // 更新设备列表
        function updateDeviceList(deviceList = devices) {
            const deviceListDiv = document.getElementById('deviceList');
            deviceListDiv.innerHTML = '';

            if (deviceList.length === 0) {
                deviceListDiv.innerHTML = '<p style="color: #64748b; text-align: center;">暂无设备</p>';
                return;
            }

            deviceList.forEach(device => {
                const isExpired = new Date(device.expire_date) < new Date();
                const deviceElement = document.createElement('div');
                deviceElement.className = 'device-item';
                deviceElement.innerHTML = `
                    <div style="flex: 1;">
                        <strong>${device.name}</strong>
                        <div style="font-size: 12px; color: #64748b;">
                            指纹: ${device.fingerprint.substring(0, 16)}...
                        </div>
                        <div style="font-size: 12px; color: ${isExpired ? '#ef4444' : '#64748b'};">
                            到期: ${device.expire_date} ${isExpired ? ' (已过期)' : ''}
                        </div>
                    </div>
                    <div>
                        <button class="btn" onclick="editDevice('${device.fingerprint}')" 
                                style="background: var(--warning); color: white; padding: 6px 12px; font-size: 12px;">
                            编辑
                        </button>
                        <button class="btn" onclick="extendDevice('${device.fingerprint}')" 
                                style="background: var(--success); color: white; padding: 6px 12px; font-size: 12px; margin-left: 5px;">
                            续期
                        </button>
                        <button class="btn" onclick="deleteDevice('${device.fingerprint}')" 
                                style="background: var(--danger); color: white; padding: 6px 12px; font-size: 12px; margin-left: 5px;">
                            删除
                        </button>
                    </div>
                `;
                deviceListDiv.appendChild(deviceElement);
            });
        }

        // 编辑设备
        function editDevice(fingerprint) {
            const device = devices.find(d => d.fingerprint === fingerprint);
            if (device) {
                document.getElementById('editFingerprint').value = device.fingerprint;
                document.getElementById('editDeviceName').value = device.name;
                document.getElementById('editAuthDays').value = device.days || 30;
                document.getElementById('editExpireDate').value = device.expire_date;
            }
        }

        // 续期设备
        function extendDevice(fingerprint) {
            const device = devices.find(d => d.fingerprint === fingerprint);
            if (device) {
                const extendDays = prompt(`请输入为设备 "${device.name}" 延长的天数:`, "30");
                if (extendDays && !isNaN(extendDays)) {
                    const days = parseInt(extendDays);
                    const currentExpireDate = new Date(device.expire_date);
                    currentExpireDate.setDate(currentExpireDate.getDate() + days);
                    
                    device.expire_date = currentExpireDate.toISOString().split('T')[0];
                    device.days = (device.days || 0) + days;
                    
                    saveDevices();
                    updateDeviceList();
                    alert(`设备已成功延长 ${days} 天`);
                }
            }
        }

        // 保存设备
        function saveDevice() {
            const fingerprint = document.getElementById('editFingerprint').value.trim();
            const name = document.getElementById('editDeviceName').value.trim();
            const days = parseInt(document.getElementById('editAuthDays').value) || 30;
            const expireDate = document.getElementById('editExpireDate').value;

            if (!fingerprint) {
                alert('请输入设备指纹');
                return;
            }

            if (!name) {
                alert('请输入设备名称');
                return;
            }

            // 计算到期日期
            let finalExpireDate = expireDate;
            if (!finalExpireDate) {
                const today = new Date();
                today.setDate(today.getDate() + days);
                finalExpireDate = today.toISOString().split('T')[0];
            }

            // 查找是否已存在
            const existingIndex = devices.findIndex(d => d.fingerprint === fingerprint);
            
            if (existingIndex !== -1) {
                // 更新现有设备
                devices[existingIndex] = {
                    ...devices[existingIndex],
                    name: name,
                    days: days,
                    expire_date: finalExpireDate,
                    last_updated: new Date().toISOString()
                };
            } else {
                // 添加新设备
                devices.push({
                    fingerprint: fingerprint,
                    name: name,
                    days: days,
                    expire_date: finalExpireDate,
                    authorized_at: new Date().toISOString(),
                    last_updated: new Date().toISOString(),
                    status: 'active'
                });
            }

            saveDevices();
            updateDeviceList();
            
            // 清空表单
            document.getElementById('editFingerprint').value = '';
            document.getElementById('editDeviceName').value = '';
            document.getElementById('editAuthDays').value = '30';
            document.getElementById('editExpireDate').value = '';
            
            alert('设备授权保存成功');
        }

        // 删除设备
        function deleteDevice(fingerprint) {
            if (confirm('确定要删除此设备授权吗？')) {
                devices = devices.filter(d => d.fingerprint !== fingerprint);
                saveDevices();
                updateDeviceList();
                alert('设备已删除');
            }
        }

        // 导出数据
        function exportData() {
            const dataStr = JSON.stringify(devices, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `authorized_devices_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        // 清理过期设备
        function clearExpired() {
            const expiredCount = devices.filter(device => 
                new Date(device.expire_date) < new Date()
            ).length;
            
            if (expiredCount === 0) {
                alert('没有找到过期设备');
                return;
            }
            
            if (confirm(`确定要清理 ${expiredCount} 个过期设备吗？`)) {
                devices = devices.filter(device => 
                    new Date(device.expire_date) >= new Date()
                );
                saveDevices();
                updateDeviceList();
                alert(`已清理 ${expiredCount} 个过期设备`);
            }
        }
    </script>
</body>
</html>
